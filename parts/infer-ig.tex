\section{Interaction Graph inference}
\resume{The Process Hitting can be used to finely model a system by defining cooperations or studying its behavior using the available tools. One can then decide to translate this model back to Thomas' modeling, and the Interaction Graph inference is the first step to perform this. It relies on an exhaustive approach that looks for possible influences of a gene on the others given all possible configurations. This part gives good results.}

In order to infer a complete BRN, one has to find the Interaction Graph first, as some constraints on the Parametrization rely on it. Inferring the Interaction Graph consists in determining the influence of all components on each of its successors.

\paragraph{Distinguish components and cooperative sorts}

The nodes of the Interaction Graph can be found by analyzing the sorts of the Process Hitting and distinguishing them from cooperative sorts using several rules inspired by the definition of cooperative sorts. for instance, components and cooperative sorts don't have the same behavior regarding the influence of other sorts: components represent the concentration of real entities and therefore cannot miss a process in a bounce. Thus, if we observe such a bounce, we know that the considered sort must be cooperative%; we define the set of sorts that must be cooperative in \ref{must_be_cs}
. On the other hand, if a sort has strictly less than 4 processes, or if none of its processes is the hitter of an action, then it cannot be used as a cooperative sort.%Furthermore, if a process $a_i$ of a given sort $a$ hits another sort $c$ to make it bounce to a certain process $c_k$, we can consider that $c_k$ represents $a_i$ if and only if $a_i$ does not hit $c_k$.
Given these observations, we define the set of sorts that must be cooperative (\ref{must_be_cs}) sorts and the set of sorts that must be components (\ref{cannot_be_cs}).
\begin{align}
\label{must_be_cs}
  M &= \{c \in \PHs \mid \exists \PHfrappe{a_i}{c_j}{c_k} \in \PHa, a \in \PHs, a_i \in \PHs_a, c_j, c_k \in \PHs_c, |j - k| > 1\} \\
\label{cannot_be_cs}
  M' &= \{c \in \PHs \mid l_c < 3\} \cup \{c \in \PHs \mid \nexists h \in \PHa, \PHhitter(h) = c\}
%\begin{split}\label{cannot_be_cs_2}
%  M'' &= \{c \in \PHs \mid \exists a \in \PHs, \exists a_i \PHs_a, \exists \sigma \in \PHs_c, \exists h, h' \in \PHa, \\
%      & \quad \quad \quad \PHhitter(h) = \PHhitter(h') = a_i \wedge \PHbounce(h) = \PHtarget(h') = c_\sigma\}
%\end{split} \\
\end{align}
Of course, if we have $M \cap M' \neq \emptyset$ then at least one sort has an ambiguous role as it exists in both sets. This case is left inconclusive and the input Process Hitting model should be revised or the cooperative sorts should be differentiated manually. We consider in the following that we have $M \cap M' = \emptyset$.

All sorts in the set $\PHs \setminus M'$ can be seen as potential cooperative sorts. One last criterion to differentiate cooperative sorts is to consider fixed points. If a sort is cooperative, this means that all sub-states of its components predecessors (possibly going though a cooperative sort) must lead to exactly one fixed point in the potentially cooperative sort. If a sub-state gives several fixed points it does not respect the definition, whereas if it gives no fixed point then this sub-state is not represented by a process of the sort. In both cases, the considered sort is not a cooperative sort.
\afaire{En fait pour être tout à fait juste il faudrait faire un point fixe ici, ce que je n'ai pas fait pour le moment}
%\begin{align}
%\label{cooperation}
%  \forall c \in \PHs, \forall c_\sigma \in \PHs_c, \zeta_{c_\sigma} &= \{a_i \in \PHs_a \mid a \in \PHs, \exists c_{\sigma'} \in \PHs_c, \PHfrappe{a_i}{c_{\sigma'}}{c_\sigma} \in \PHa\} \\
%\end{align}

***
\[\mathcal A(L_a,\sigma) = \{ \PHfrappe{b_j}{a_j}{a_k} \in \mathcal A \mid 
	a_j\in L_a \wedge a_k\in L_a \wedge (b_j\in \sigma \vee b_j \in L_a) \}\]

\begin{definition}[$\focals(L_a,\sigma)$]
Let us define the directed graph $G = (L_a, V)$ where arcs are the bounces within the sort $a$
triggered by actions in $\mathcal A(L_a,\sigma)$:
\[V = \{(a_j,a_k)\in (L_a \times L_a) \mid 
			\exists\PHfrappe{b_i}{a_j}{a_k}\in \mathcal A(L_a,\sigma)\}\enspace.\]
\[
\focals(L_a,\sigma) = 
\begin{cases}
\{ a_i \in L_a \mid \nexists (a_i,a_j)\in V\} & \text{if $G$ is acyclic},\\
\emptyset & \text{otherwise.}\\
\end{cases}
\]
\end{definition}
\begin{lemma}~
\begin{enumerate}
\item if $\focals(L_a,\sigma)=\emptyset$, there exists a 
state $s\in L$ with $s[a]\in L_a$ and $\sigma\subset s$
such that $\forall n\in\mathbb N$ there 
exists a scenario of length $n'>n$ of actions in $\mathcal A(L_a,\sigma)$.
\item if $\focals(L_a,\sigma)\neq\emptyset$, for all
state $s\in L$ with $s[a]\in L_a$ and $\sigma\subset s$, for each scenario $\delta$ playable in $s$
either
\begin{itemize}
\item $s\play\delta[a] \in \focals(L_a,\sigma)$
\item or, $\exists h\in \mathcal A(L_a,\sigma)$ playable in $s\play\delta$.
\end{itemize}
Moreover the size of $\delta$ is bound by $|\mathcal A(L_a,\sigma)|$.
\end{enumerate}
\end{lemma}
\begin{proof}
From $\focals$ definition.
\end{proof}
\begin{property}[Well-formed cooperative sort]
A sort $\upsilon\in\PHs$ is a well-formed cooperative sort if and only if
each configuration $\sigma$ of its predecessors leads $\upsilon$ to a unique focal process,
denoted by $\upsilon[\sigma]$:
\[
\forall \sigma \in \prod_{a\in\PHdirectpredec{\upsilon}} \PHs_{a},
\focals(\PHs_\upsilon,\sigma) = \{ \upsilon[\sigma] \}\]
\end{property}
Note: for the sake of simplicity, we do not allow the existence of multiple focal processes.

\begin{property}[Well-formed PH for BRN inference]
A PH is well-formed for BRN inference if and only if each sort $a\in\PHs$ either satisfies
\[\nexists \PHfrappe{b_i}{a_j}{a_k}\in\PHa, |j-k| > 1
\enspace,\]
or is a well-formed cooperative sort.
\end{property}

Given a well-formed PH, the set $\Gamma$ of components hence is given in \eqref{eq:PH-components};
other sorts are well-formed cooperative sorts.
\begin{equation}
\Gamma = \{a \in \PHs \mid \nexists \PHfrappe{b_i}{a_j}{a_k} \in \PHa, |j - k| > 1\} \\
\label{eq:PH-components}
\end{equation}

***

\todo{Start a running example here --- maybe re-use the example of previous section}

\begin{center}
\begin{tikzpicture}
% Sortes
\TSort{(0,3)}{a}{2}{l}
\TSort{(0,0)}{b}{2}{l}
\TSetTick{ab}{0}{00}
\TSetTick{ab}{1}{01}
\TSetTick{ab}{2}{10}
\TSetTick{ab}{3}{11}
\TSort{(3,0.5)}{ab}{4}{r}
\TSort{(6,1)}{z}{3}{r}

% Actions de màj de ab
\THit{a_1}{}{ab_0}{.west}{ab_2}
\THit{a_1}{}{ab_1}{.west}{ab_3}
\path[bounce,bend left] \TBounce{ab_0}{}{ab_2}{.south} \TBounce{ab_1}{}{ab_3}{.south};

\THit{a_0}{}{ab_2}{.west}{ab_0}
\THit{a_0}{}{ab_3}{.west}{ab_1}
\path[bounce,bend right] \TBounce{ab_2}{}{ab_0}{.north} \TBounce{ab_3}{}{ab_1}{.north};

\THit{b_0}{}{ab_3}{.west}{ab_2}
\THit{b_0}{}{ab_1}{.west}{ab_0}
\THit{b_1}{}{ab_0}{.west}{ab_1}
\THit{b_1}{}{ab_2}{.west}{ab_3}
\path[bounce,bend right] \TBounce{ab_1}{}{ab_0}{.north} \TBounce{ab_3}{}{ab_2}{.north};
\path[bounce,bend left] \TBounce{ab_0}{}{ab_1}{.south} \TBounce{ab_2}{}{ab_3}{.south};

% Arcs sortant de ab
\THit{ab_2}{}{z_1}{.north west}{z_2}
\THit{ab_2}{}{z_0}{.north west}{z_1}
\path[bounce,bend left] \TBounce{z_1}{}{z_2}{.south} \TBounce{z_0}{}{z_1}{.south};
\THit{ab_3}{}{z_2}{.south west}{z_1}
\THit{ab_3}{}{z_0}{.north west}{z_1}
\path[bounce,bend left] \TBounce{z_2}{bend right}{z_1}{.north} \TBounce{z_0}{}{z_1}{.south};
\THit{ab_1}{}{z_2}{.south west}{z_1}
\THit{ab_1}{}{z_1}{.south west}{z_0}
\path[bounce,bend right] \TBounce{z_2}{}{z_1}{.north} \TBounce{z_1}{}{z_0}{.north};
\THit{ab_0}{}{z_2}{.south west}{z_1}
\THit{ab_0}{}{z_1}{.south west}{z_0}
\path[bounce,bend right] \TBounce{z_2}{}{z_1}{.north} \TBounce{z_1}{}{z_0}{.north};
\end{tikzpicture}
\end{center}

\todo{Algorithm to infer IG}
At this point we can divide the set of sorts $\PHs$ into components ($\Gamma$) and cooperative sorts ($\PHs \setminus \Gamma$) that will not appear in the Interaction Graph. In (\ref{ph_direct_predec}) we define the notion of direct predecessors in a Process Hitting by considering the actions between sorts, and we extend it in (\ref{ph_predec}) to a broader notion of predecessor, where we define the influence of sort to another by considering actions and possible cooperative sorts. This latter can be compared to the notion of predecessors of Gene Networks.
\begin{align}
\label{ph_direct_predec}
  \forall b \in \PHs, \PHdirectpredec{b} &= \{a \in \PHs \mid \exists h \in \PHa, \PHsort(\PHhitter(h)) = a \wedge \PHsort(\PHtarget(h)) = b\} \\
\begin{split}\label{ph_predec}
  \forall b \in \PHs, \PHpredec{b} &= \{a \in \PHs \mid \exists n \in \mathbb{N}^*, \exists (c^k)_{k \in \llbracket 0 ; n \rrbracket} \in \PHs^{n+1}, \\
                                   & \quad \quad c^0 = a \wedge c^n = b \wedge c_0 \in \PHdirectpredec{c_1} \\
                                   & \quad \quad \wedge \forall k \in \llbracket 1 ; n-1 \rrbracket, c^k \in \PHdirectpredec{c^{k+1}} \cap (\PHs\setminus\Gamma)\}
\end{split}
\end{align}

We now aim to determine what kind of influence gets each component from its component predecessors. %For this, we consider any possible influence and consider
Let $b \in \Gamma$ be a component and $a \in \PHpredec{b} \cap \Gamma$ a component that may influence it. We define in (\ref{sub-state_predec}) the set $C$ of possible sub-states for all other component predecessors of $b$.
\begin{align}
\label{sub-state_predec}
  C_{a \rightarrow b} &= \{\PHetat{c^n_i} \in \mathop{\times}_{c^n \in \PHpredecgene{b}} \PHs_{c^n}\}
\end{align}
The point of this approach is to understand, in a given sub-state, the influence of $a$ by comparing the focal states of $b$ in each state of $a$. For a given sub-state $\sigma \in C_{a \rightarrow b}$ of component predecessors of $b$ and a given process $a_i \in \PHs_a$ of $a$, we define the context of each predecessor $c \in \PHpredec{b}$ of $b$. This context is only the chosen process for $a$ (\ref{sub-state_a_predec}) and all component predecessors (\ref{sub-state_gene_predec}). In case of a cooperative sort, the context is the process that represents the sub-state of its predecessors (\ref{sub-state_cs_predec}).
\begin{align}
\label{sub-state_a_predec}
  C^{a}_{a_i,\sigma,b} &= a_i \\
\label{sub-state_gene_predec}
  \forall c \in \PHpredecgene{b}, C^{c}_{a_i,\sigma,b} &= \PHget{\sigma}{c} \\
\label{sub-state_cs_predec}
  \forall \upsilon \in \PHpredeccs{b}, C^{\upsilon}_{a_i,\sigma,b} &= \upsilon_\varsigma \quad \text{where: } \forall c \in \PHdirectpredec{\upsilon}, \PHget{\varsigma}{c} = \PHget{\sigma}{c}
\end{align}

\todo{Illustrate with the example}

%The set of firable actions in the considered context is defined in (\ref{ig_firable}).
The focal processes of $b$ are defined in (\ref{ig_focal_processes_notauto}) as the processes that are not the target of a firable action in the considered context. Here, we have to distinguish the case where $b$ is one of its own predecessors: in this case, considering other processes than the neighbors of the selected process is not relevant.
%\begin{align}
%\label{ig_firable}
%  \PHa_{a_i,\sigma,b} &= \{h \in \PHa \mid \PHhitter(h) = C^{\PHsort(\PHhitter(h))}_{a_i,\sigma,b}, \PHsort(\PHtarget(h)) = b\}
%\end{align}
\begin{itemize}
  \item If $b \neq a$:
\begin{align}
\label{ig_focal_processes_notauto}
  \mathsf{L}_{a_i,\sigma,b} &= \{b_j \in \PHs_b \mid \nexists h \in \PHa, C^{\PHsort(\PHhitter(h))}_{a_i,\sigma,b} = \PHhitter(h), \PHtarget(h) = b_i\}
\end{align}
  \item If $b = a$:
\begin{align}
\label{ig_focal_processes_auto}
  \mathsf{L}_{b_i,\sigma,b} &=
    \left\{\begin{array}{l}
      \{0\} \quad \text{if } \nexists h \in \PHa, \PHhitter(h) = \PHtarget(h) = b_i \\
      \{j \in \{+1 ; -1\} \mid \exists h \in \PHa, \PHtarget(h) = b_i\\
      \quad\quad\quad\quad \wedge \PHbounce(h) = b_{i+j}\} \quad \text{else}
    \end{array}\right.
\end{align}
\end{itemize}

At this point, we need to check that the focal processes found are attractors. The set of focal processes has to verify the following:
\begin{itemize}
  \item If $b \neq a$:
\begin{align}
\label{ig_attractor_noauto}
  \forall \PHfrappe{c_i}{b_j}{b_k} \in \PHa, c_i = C^{c}_{a_i,\sigma,b}, \forall b_f \in \mathsf{L}_{a_i,\sigma,b}, |f-k| < |f-j|
\end{align}
  \item If $b = a$:
\begin{align}
\label{ig_attractor_auto}
  \mathsf{L}_{b_i,\sigma,b} \neq \{+1 ; -1\}
\end{align}
\end{itemize}
In the case where the focal processes are not attractors, the studied Process Hitting model can't be expressed as a Biological Regulatory Network. Indeed, there exists a state where a component is attracted in two different directions and it is not possible to model such a behavior with Thomas' modeling. This condition also ensures that the sets of focal processes are intervals.

By comparing the focal processes sets obtained, we can determine the sign of the influence of $a$ on $b$. Indeed, let $a_i$, $a_j$ be two processes of $a$ such as $i < j$ \todo{Ordre sur les processus plutôt que sur les $i$ / $j$ ?}, then $a$ activates $b$ in the sub-state $\sigma$ if $\mathsf{L}_{a_i,\sigma,b} <_{[]} \mathsf{L}_{a_j,\sigma,b}$; it inhibits $b$ in the sub-state $\sigma$ if $\mathsf{L}_{a_j,\sigma,b} <_{[]} \mathsf{L}_{a_i,\sigma,b}$, where the relation $<_{[]}$ compares intervals and is defined in (\ref{compare}).
\begin{align}
\label{compare}
  [a_{i,1} ; a_{i,2}] <_{[]} [a_{j,1} ; a_{j,2}] \Leftrightarrow (a_{i,1} < a_{j,1} \wedge a_{i,2} \leq a_{j,2}) \vee (a_{i,1} \leq a_{j,1} \wedge a_{i,2} < a_{j,2})
\end{align}

\todo{Conclusion: edge + threshold}


\todo{Illustrate with the example}

\todo{Discuss of errors/inconclusive cases}
